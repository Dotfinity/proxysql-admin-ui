@page "/mysql/rules/edit/{RuleId:int}"

@using ProxysqlAdminUi.Web.Models
@using ProxysqlAdminUi.Web.Repositories

@attribute [Authorize]

@inject DialogService DialogService
@inject NotificationService NotificationService
@inject ProxySqlRepository ProxySqlRepository

<RadzenContent Container="main">
    <RadzenStack Gap="1rem">
        @if (_queryRule != null)
        {
            <RadzenTemplateForm TItem="MysqlQueryRule" Data=@_queryRule Submit=@OnSubmit>
                <RadzenCard>
                    <RadzenStack Gap="1rem">
                        <RadzenRow>
                            <RadzenColumn Size="4">
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                    <RadzenCheckBox @bind-Value=@_queryRule.Active Name="@nameof(MysqlQueryRule.Active)" />
                                    <RadzenLabel Text="Active" Component="@nameof(MysqlQueryRule.Active)" />
                                </RadzenStack>
                            </RadzenColumn>
                            <RadzenColumn Size="4">
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                    <RadzenCheckBox @bind-Value=@_queryRule.Apply Name="@nameof(MysqlQueryRule.Apply)" />
                                    <RadzenLabel Text="Apply" Component="@nameof(MysqlQueryRule.Apply)" />
                                </RadzenStack>
                            </RadzenColumn>
                            <RadzenColumn Size="4">
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                    <RadzenCheckBox @bind-Value=@_queryRule.NegateMatchPattern Name="@nameof(MysqlQueryRule.NegateMatchPattern)" />
                                    <RadzenLabel Text="Negate Match" Component="@nameof(MysqlQueryRule.NegateMatchPattern)" />
                                </RadzenStack>
                            </RadzenColumn>
                        </RadzenRow>

                        <RadzenRow>
                            <RadzenColumn Size="6">
                                <RadzenStack>
                                    <RadzenLabel Text="Username" />
                                    <RadzenTextBox @bind-Value=@_queryRule.Username Name="@nameof(MysqlQueryRule.Username)" />
                                </RadzenStack>
                            </RadzenColumn>
                            <RadzenColumn Size="6">
                                <RadzenStack>
                                    <RadzenLabel Text="Schema Name" />
                                    <RadzenTextBox @bind-Value=@_queryRule.Schemaname Name="@nameof(MysqlQueryRule.Schemaname)" />
                                </RadzenStack>
                            </RadzenColumn>
                        </RadzenRow>

                        <RadzenRow>
                            <RadzenColumn Size="6">
                                <RadzenStack>
                                    <RadzenLabel Text="Client Address" />
                                    <RadzenTextBox @bind-Value=@_queryRule.ClientAddr Name="@nameof(MysqlQueryRule.ClientAddr)" />
                                </RadzenStack>
                            </RadzenColumn>
                            <RadzenColumn Size="6">
                                <RadzenStack>
                                    <RadzenLabel Text="Proxy Address" />
                                    <RadzenTextBox @bind-Value=@_queryRule.ProxyAddr Name="@nameof(MysqlQueryRule.ProxyAddr)" />
                                </RadzenStack>
                            </RadzenColumn>
                        </RadzenRow>

                        <RadzenRow>
                            <RadzenColumn Size="6">
                                <RadzenStack>
                                    <RadzenLabel Text="Proxy Port" />
                                    <RadzenNumeric @bind-Value=@_queryRule.ProxyPort Name="@nameof(MysqlQueryRule.ProxyPort)" />
                                </RadzenStack>
                            </RadzenColumn>
                            <RadzenColumn Size="6">
                                <RadzenStack>
                                    <RadzenLabel Text="Flag In" />
                                    <RadzenNumeric @bind-Value=@_queryRule.FlagIn Name="@nameof(MysqlQueryRule.FlagIn)" />
                                </RadzenStack>
                            </RadzenColumn>
                        </RadzenRow>

                        <RadzenRow>
                            <RadzenColumn Size="12">
                                <RadzenStack>
                                    <RadzenLabel Text="Match Pattern" />
                                    <RadzenTextArea @bind-Value=@_queryRule.MatchPattern Name="@nameof(MysqlQueryRule.MatchPattern)" />
                                </RadzenStack>
                            </RadzenColumn>
                        </RadzenRow>

                        <RadzenRow>
                            <RadzenColumn Size="6">
                                <RadzenStack>
                                    <RadzenLabel Text="Match Digest" />
                                    <RadzenTextBox @bind-Value=@_queryRule.MatchDigest Name="@nameof(MysqlQueryRule.MatchDigest)" />
                                </RadzenStack>
                            </RadzenColumn>
                            <RadzenColumn Size="6">
                                <RadzenStack>
                                    <RadzenLabel Text="Digest" />
                                    <RadzenTextBox @bind-Value=@_queryRule.Digest Name="@nameof(MysqlQueryRule.Digest)" />
                                </RadzenStack>
                            </RadzenColumn>
                        </RadzenRow>

                        <RadzenRow>
                            <RadzenColumn Size="6">
                                <RadzenStack>
                                    <RadzenLabel Text="RE Modifiers" />
                                    <RadzenTextBox @bind-Value=@_queryRule.ReModifiers Name="@nameof(MysqlQueryRule.ReModifiers)" />
                                </RadzenStack>
                            </RadzenColumn>
                            <RadzenColumn Size="6">
                                <RadzenStack>
                                    <RadzenLabel Text="Flag Out" />
                                    <RadzenNumeric @bind-Value=@_queryRule.FlagOut Name="@nameof(MysqlQueryRule.FlagOut)" />
                                </RadzenStack>
                            </RadzenColumn>
                        </RadzenRow>

                        <RadzenRow>
                            <RadzenColumn Size="6">
                                <RadzenStack>
                                    <RadzenLabel Text="Replace Pattern" />
                                    <RadzenTextBox @bind-Value=@_queryRule.ReplacePattern Name="@nameof(MysqlQueryRule.ReplacePattern)" />
                                </RadzenStack>
                            </RadzenColumn>
                            <RadzenColumn Size="6">
                                <RadzenStack>
                                    <RadzenLabel Text="Destination Hostgroup" />
                                    <RadzenNumeric @bind-Value=@_queryRule.DestinationHostgroup Name="@nameof(MysqlQueryRule.DestinationHostgroup)" />
                                </RadzenStack>
                            </RadzenColumn>
                        </RadzenRow>

                        <RadzenRow>
                            <RadzenColumn Size="4">
                                <RadzenStack>
                                    <RadzenLabel Text="Cache TTL" />
                                    <RadzenNumeric @bind-Value=@_queryRule.CacheTtl Name="@nameof(MysqlQueryRule.CacheTtl)" Min="1" />
                                </RadzenStack>
                            </RadzenColumn>
                            <RadzenColumn Size="4">
                                <RadzenStack>
                                    <RadzenLabel Text="Cache Timeout" />
                                    <RadzenNumeric @bind-Value=@_queryRule.CacheTimeout Name="@nameof(MysqlQueryRule.CacheTimeout)" />
                                </RadzenStack>
                            </RadzenColumn>
                            <RadzenColumn Size="4">
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                    <RadzenCheckBox @bind-Value=@_queryRule.CacheEmptyResult Name="@nameof(MysqlQueryRule.CacheEmptyResult)" />
                                    <RadzenLabel Text="Cache Empty Result" Component="@nameof(MysqlQueryRule.CacheEmptyResult)" />
                                </RadzenStack>
                            </RadzenColumn>
                        </RadzenRow>

                        <RadzenRow>
                            <RadzenColumn Size="4">
                                <RadzenStack>
                                    <RadzenLabel Text="Retries" />
                                    <RadzenNumeric @bind-Value=@_queryRule.Retries Name="@nameof(MysqlQueryRule.Retries)" />
                                </RadzenStack>
                            </RadzenColumn>
                            <RadzenColumn Size="4">
                                <RadzenStack>
                                    <RadzenLabel Text="Delay" />
                                    <RadzenNumeric @bind-Value=@_queryRule.Delay Name="@nameof(MysqlQueryRule.Delay)" />
                                </RadzenStack>
                            </RadzenColumn>
                            <RadzenColumn Size="4">
                                <RadzenStack>
                                    <RadzenLabel Text="Next Query Flag In" />
                                    <RadzenNumeric @bind-Value=@_queryRule.NextQueryFlagIn Name="@nameof(MysqlQueryRule.NextQueryFlagIn)" />
                                </RadzenStack>
                            </RadzenColumn>
                        </RadzenRow>

                        <RadzenRow>
                            <RadzenColumn Size="6">
                                <RadzenStack>
                                    <RadzenLabel Text="Mirror Flag Out" />
                                    <RadzenNumeric @bind-Value=@_queryRule.MirrorFlagOut Name="@nameof(MysqlQueryRule.MirrorFlagOut)" />
                                </RadzenStack>
                            </RadzenColumn>
                            <RadzenColumn Size="6">
                                <RadzenStack>
                                    <RadzenLabel Text="Mirror Hostgroup" />
                                    <RadzenNumeric @bind-Value=@_queryRule.MirrorHostgroup Name="@nameof(MysqlQueryRule.MirrorHostgroup)" />
                                </RadzenStack>
                            </RadzenColumn>
                        </RadzenRow>

                        <RadzenRow>
                            <RadzenColumn Size="6">
                                <RadzenStack>
                                    <RadzenLabel Text="Error Message" />
                                    <RadzenTextBox @bind-Value=@_queryRule.ErrorMsg Name="@nameof(MysqlQueryRule.ErrorMsg)" />
                                </RadzenStack>
                            </RadzenColumn>
                            <RadzenColumn Size="6">
                                <RadzenStack>
                                    <RadzenLabel Text="OK Message" />
                                    <RadzenTextBox @bind-Value=@_queryRule.OKMsg Name="@nameof(MysqlQueryRule.OKMsg)" />
                                </RadzenStack>
                            </RadzenColumn>
                        </RadzenRow>

                        <RadzenRow>
                            <RadzenColumn Size="4">
                                <RadzenStack>
                                    <RadzenLabel Text="Multiplex" />
                                    <RadzenNumeric @bind-Value=@_queryRule.Multiplex Name="@nameof(MysqlQueryRule.Multiplex)" Max="2" />
                                </RadzenStack>
                            </RadzenColumn>
                            <RadzenColumn Size="4">
                                <RadzenStack>
                                    <RadzenLabel Text="GTID From Hostgroup" />
                                    <RadzenNumeric @bind-Value=@_queryRule.GtidFromHostgroup Name="@nameof(MysqlQueryRule.GtidFromHostgroup)" />
                                </RadzenStack>
                            </RadzenColumn>
                            <RadzenColumn Size="4">
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                    <RadzenCheckBox @bind-Value=@_queryRule.Log Name="@nameof(MysqlQueryRule.Log)" />
                                    <RadzenLabel Text="Log" Component="@nameof(MysqlQueryRule.Log)" />
                                </RadzenStack>
                            </RadzenColumn>
                        </RadzenRow>

                        <RadzenRow>
                            <RadzenColumn Size="12">
                                <RadzenStack>
                                    <RadzenLabel Text="Comment" />
                                    <RadzenTextArea @bind-Value=@_queryRule.Comment Name="@nameof(MysqlQueryRule.Comment)" />
                                </RadzenStack>
                            </RadzenColumn>
                        </RadzenRow>

                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="1rem">
                            <RadzenButton ButtonType="ButtonType.Submit" Text="Save" ButtonStyle="ButtonStyle.Primary" />
                            <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click=@OnCancel />
                        </RadzenStack>

                    </RadzenStack>
                </RadzenCard>
            </RadzenTemplateForm>
        }
        else
        {
            <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        }
    </RadzenStack>
</RadzenContent>
@code {
    [Parameter]
    public int RuleId { get; set; }

    private MysqlQueryRule _queryRule;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _queryRule = await ProxySqlRepository.GetMySqlQueryRule(RuleId);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load query rule: " + ex.Message);
            DialogService.Close();
        }
    }

    private async Task OnSubmit()
    {
        try
        {
            await ProxySqlRepository.UpdateMySqlQueryRule(_queryRule);
            NotificationService.Notify(NotificationSeverity.Success, "Success", "Query rule updated successfully");
            DialogService.Close(true);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to update query rule: " + ex.Message);
        }
    }

    private void OnCancel()
    {
        DialogService.Close(false);
    }
}